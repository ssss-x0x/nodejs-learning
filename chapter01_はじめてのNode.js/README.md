# Node.js の言語としての特徴

## 非同期のイベント駆動型ランタイム

JavaScript はブラウザ上で発生する非同期的なイベントを処理していたが、Node.js はサーバー上で、OS から発生する非同期的なイベントを処理する。

発行されるイベントをベースにした処理を「イベント駆動型」と表現し、実行環境である Node.js は「非同期のイベント駆動型ランタイム」と呼ばれている。

## シングルスレッド

Node.js は、1 つのプロセスに対して 1 つのスレッドを生成する「シングルスレッド」で動作する。

※ プロセス = 実行されているプログラムを管理する単位

## イベントループと Non-Blocking I/O

### Non-Blocking I/O

シングルスレッドで Blocking I/O の場合、1 つ目のリクエストが完了するまでは 2 つ目のリクエストはレスポンスを返せない。

しかし、Non-Blocking I/O であればリクエスト内の I/O を一定の塊（イベント）に分割し、それぞれのイベントを細切れに実行することで他のイベントをブロックせずに処理を進めることができる。

Node.js がシングルスレッドでも性能を発揮できるのは Non-Blocking I/O のおかげ

### イベントループ

Node.js では I/O などのイベントが発生すると、内部に持つキュー的な場所にタスクを詰める。  
その詰められたタスクを取り出すために繰り返されるのが「イベントループ」。

I/O 処理を呼び出した時にはすぐに処理はされず、上記のとおりキューを発行してイベントループによってタスクが取り出されるのを待っている。

そのため、イベントループが止まると一生次の処理が動かなくなってしまうので、Node.js ではいかにイベントループを停止させないかが大事。

[参考: イベントループ](https://nodejs.org/en/learn/asynchronous-work/event-loop-timers-and-nexttick)

## C10K 問題と Node.js

C10K 問題 = 同時接続するクライアントが 10K となった場合に、ソフトウェアの性能が発揮しきれなくなる問題。  
サーバーへの同時接続が上限数を超えた時に、プロセスが割り当てられなくなってしまい、CPU などのリソースに余裕があったとしてもサービスとしての応答が悪化する事象が発生する。

Node.js では Non-Blocking I/O とシングルスレッドを用いて対処している。  
多数のリクエストを受けても同時に処理する能力が高く、リソースを効率的に活用できる。

### Node.js の注意点

- 動画エンコーディングなどの CPU 中心の処理などを大量に受け付けてしまうと、他の処理をブロックしてしまいイベントループが回りにくくなってしまうためイベントハンドリングがうまくいかなくなる危険性がある。
- 同期処理は避けた方が良い
